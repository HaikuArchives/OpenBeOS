SubDir OBOS_TOP sources os kits kernel ;

KernelStaticLibraryObjects libc.a :
	<$(SOURCE_GRIST)!libc>nulibc_init.o

	<$(SOURCE_GRIST)!libc!hoard>arch-specific.o
	<$(SOURCE_GRIST)!libc!hoard>heap.o
	<$(SOURCE_GRIST)!libc!hoard>processheap.o
	<$(SOURCE_GRIST)!libc!hoard>superblock.o
	<$(SOURCE_GRIST)!libc!hoard>threadheap.o
	<$(SOURCE_GRIST)!libc!hoard>wrapper.o

	<$(SOURCE_GRIST)!libc!locale>ctype.o

	<$(SOURCE_GRIST)!libc!stdio>stdio.o
	<$(SOURCE_GRIST)!libc!stdio>vsprintf.o

	<$(SOURCE_GRIST)!libc!stdlib>assert.o
	<$(SOURCE_GRIST)!libc!stdlib>atoi.o
	<$(SOURCE_GRIST)!libc!stdlib>bsearch.o
	<$(SOURCE_GRIST)!libc!stdlib>heapsort.o
	<$(SOURCE_GRIST)!libc!stdlib>merge.o
	<$(SOURCE_GRIST)!libc!stdlib>qsort.o
	<$(SOURCE_GRIST)!libc!stdlib>radixsort.o
	<$(SOURCE_GRIST)!libc!stdlib>rand.o
	<$(SOURCE_GRIST)!libc!stdlib>random.o

	<$(SOURCE_GRIST)!libc!string>bcopy.o
	<$(SOURCE_GRIST)!libc!string>bzero.o
	<$(SOURCE_GRIST)!libc!string>memchr.o
	<$(SOURCE_GRIST)!libc!string>memcmp.o
	<$(SOURCE_GRIST)!libc!string>memcpy.o
	<$(SOURCE_GRIST)!libc!string>memmove.o
	<$(SOURCE_GRIST)!libc!string>memset.o
	<$(SOURCE_GRIST)!libc!string>strcat.o
	<$(SOURCE_GRIST)!libc!string>strchr.o
	<$(SOURCE_GRIST)!libc!string>strcmp.o
	<$(SOURCE_GRIST)!libc!string>strcpy.o
	<$(SOURCE_GRIST)!libc!string>strerror.o
	<$(SOURCE_GRIST)!libc!string>strlcat.o
	<$(SOURCE_GRIST)!libc!string>strlcpy.o
	<$(SOURCE_GRIST)!libc!string>strlen.o
	<$(SOURCE_GRIST)!libc!string>strncat.o
	<$(SOURCE_GRIST)!libc!string>strncmp.o
	<$(SOURCE_GRIST)!libc!string>strncpy.o
	<$(SOURCE_GRIST)!libc!string>strnicmp.o
	<$(SOURCE_GRIST)!libc!string>strnlen.o
	<$(SOURCE_GRIST)!libc!string>strpbrk.o
	<$(SOURCE_GRIST)!libc!string>strrchr.o
	<$(SOURCE_GRIST)!libc!string>strspn.o
	<$(SOURCE_GRIST)!libc!string>strstr.o
	<$(SOURCE_GRIST)!libc!string>strtok.o

	<$(SOURCE_GRIST)!libc!system>dlfcn.o
	<$(SOURCE_GRIST)!libc!system>rlimit.o
	<$(SOURCE_GRIST)!libc!system>syscalls.o
	<$(SOURCE_GRIST)!libc!system!arch!$(OBOS_ARCH)>atomic.o

	<$(SOURCE_GRIST)!libc!unistd>close.o
	<$(SOURCE_GRIST)!libc!unistd>dup.o
	<$(SOURCE_GRIST)!libc!unistd>dup2.o
	<$(SOURCE_GRIST)!libc!unistd>lseek.o
	<$(SOURCE_GRIST)!libc!unistd>open.o
	<$(SOURCE_GRIST)!libc!unistd>pread.o
	<$(SOURCE_GRIST)!libc!unistd>pwrite.o
	<$(SOURCE_GRIST)!libc!unistd>read.o
	<$(SOURCE_GRIST)!libc!unistd>sleep.o
	<$(SOURCE_GRIST)!libc!unistd>usleep.o
	<$(SOURCE_GRIST)!libc!unistd>write.o
	;

KernelStaticLibraryObjects libm.a :
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>fabs.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>frexp.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>isinf.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>ldexp.o

	<$(SOURCE_GRIST)!libm!common>atan2.o 
	<$(SOURCE_GRIST)!libm!common>sincos.o
	<$(SOURCE_GRIST)!libm!common>tan.o

	<$(SOURCE_GRIST)!libm!common_source>acosh.o
	<$(SOURCE_GRIST)!libm!common_source>asincos.o 
	<$(SOURCE_GRIST)!libm!common_source>asinh.o 
	<$(SOURCE_GRIST)!libm!common_source>atan.o
	<$(SOURCE_GRIST)!libm!common_source>atanh.o 
	<$(SOURCE_GRIST)!libm!common_source>cosh.o 
	<$(SOURCE_GRIST)!libm!common_source>erf.o
	<$(SOURCE_GRIST)!libm!common_source>exp.o 
	<$(SOURCE_GRIST)!libm!common_source>exp__E.o 
	<$(SOURCE_GRIST)!libm!common_source>expm1.o 
	<$(SOURCE_GRIST)!libm!common_source>floor.o 
	<$(SOURCE_GRIST)!libm!common_source>fmod.o
	<$(SOURCE_GRIST)!libm!common_source>gamma.o 
	<$(SOURCE_GRIST)!libm!common_source>j0.o 
	<$(SOURCE_GRIST)!libm!common_source>j1.o 
	<$(SOURCE_GRIST)!libm!common_source>jn.o
	<$(SOURCE_GRIST)!libm!common_source>lgamma.o 
	<$(SOURCE_GRIST)!libm!common_source>log.o
	<$(SOURCE_GRIST)!libm!common_source>log10.o 
	<$(SOURCE_GRIST)!libm!common_source>log1p.o
	<$(SOURCE_GRIST)!libm!common_source>log__L.o 
	<$(SOURCE_GRIST)!libm!common_source>pow.o 
	<$(SOURCE_GRIST)!libm!common_source>sinh.o 
	<$(SOURCE_GRIST)!libm!common_source>tanh.o

	<$(SOURCE_GRIST)!libm!ieee>cabs.o
	<$(SOURCE_GRIST)!libm!ieee>cbrt.o
	<$(SOURCE_GRIST)!libm!ieee>support.o
	;

KernelLd stage2
	:
	<$(SOURCE_GRIST)!boot!arch!$(OBOS_ARCH)>stage2.o
	<$(SOURCE_GRIST)!boot!arch!$(OBOS_ARCH)>stage2_asm.o
	<$(SOURCE_GRIST)!boot!arch!$(OBOS_ARCH)>smp_boot.o
	<$(SOURCE_GRIST)!boot!arch!$(OBOS_ARCH)>smp_trampoline.o
	libc.a
	:
	$(SUBDIR)/boot/arch/$(OBOS_ARCH)/stage2.ld 
	:
	-dN
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bootstrap : stage2 ;
	
KernelLd kernel 
	:
	<$(SOURCE_GRIST)!core>cbuf.o 
	<$(SOURCE_GRIST)!core>console.o 
	<$(SOURCE_GRIST)!core>cpu.o 
	<$(SOURCE_GRIST)!core>debug.o 
	<$(SOURCE_GRIST)!core>elf.o
	<$(SOURCE_GRIST)!core>faults.o
	<$(SOURCE_GRIST)!core>gdb.o
	<$(SOURCE_GRIST)!core>heap.o
	<$(SOURCE_GRIST)!core>int.o
	<$(SOURCE_GRIST)!core>khash.o 
	<$(SOURCE_GRIST)!core>lock.o 
	<$(SOURCE_GRIST)!core>main.o 
	<$(SOURCE_GRIST)!core>misc.o
	<$(SOURCE_GRIST)!core>module.o 
	<$(SOURCE_GRIST)!core>port.o
	<$(SOURCE_GRIST)!core>queue.o 
	<$(SOURCE_GRIST)!core>sem.o 
	<$(SOURCE_GRIST)!core>smp.o
	<$(SOURCE_GRIST)!core>syscalls.o 
	<$(SOURCE_GRIST)!core>thread.o 
	<$(SOURCE_GRIST)!core>timer.o

	linkhack.so

	libbus.a
	libfs.a
	libvm.a
	lib$(OBOS_ARCH).a
	libdrivers.a
	libide.a
	libkeyboard.a
	libps2mouse.a
	libc.a
	:
	$(SUBDIR)/core/arch/$(OBOS_ARCH)/kernel.ld 
	:
	-Bdynamic -export-dynamic -dynamic-linker /foo/bar
	;

KernelConfigSection config.$(OBOS_ARCH).ini : kernel : kernel ;

KernelLd kernel.so
	:
	<$(SOURCE_GRIST)!core>cbuf.o 
	<$(SOURCE_GRIST)!core>console.o 
	<$(SOURCE_GRIST)!core>cpu.o 
	<$(SOURCE_GRIST)!core>debug.o 
	<$(SOURCE_GRIST)!core>elf.o
	<$(SOURCE_GRIST)!core>faults.o
	<$(SOURCE_GRIST)!core>gdb.o
	<$(SOURCE_GRIST)!core>heap.o
	<$(SOURCE_GRIST)!core>int.o
	<$(SOURCE_GRIST)!core>khash.o 
	<$(SOURCE_GRIST)!core>lock.o 
	<$(SOURCE_GRIST)!core>main.o 
	<$(SOURCE_GRIST)!core>misc.o
	<$(SOURCE_GRIST)!core>module.o 
	<$(SOURCE_GRIST)!core>port.o
	<$(SOURCE_GRIST)!core>queue.o 
	<$(SOURCE_GRIST)!core>sem.o 
	<$(SOURCE_GRIST)!core>smp.o
	<$(SOURCE_GRIST)!core>syscalls.o 
	<$(SOURCE_GRIST)!core>thread.o 
	<$(SOURCE_GRIST)!core>timer.o

	linkhack.so

	libbus.a
	libfs.a
	libvm.a
	lib$(OBOS_ARCH).a
	libdrivers.a
	libide.a
	libkeyboard.a
	libps2mouse.a
	libc.a
	:
	$(SUBDIR)/core/arch/$(OBOS_ARCH)/kernel.ld 
	:
	-Bdynamic -shared -export-dynamic -dynamic-linker /foo/bar
	;

KernelLd iso9660
	:
	<$(SOURCE_GRIST)!core!addons!fs!iso9660>isofs.o
	kernel.so
	:
	$(SUBDIR)/core/addons/ldscripts/$(OBOS_ARCH)/addon.ld
	:
	-Bdynamic -shared
	;

KernelConfigSection config.$(OBOS_ARCH).ini : addons/fs/iso9660 : iso9660 ;

KernelLd zfs
	:
	<$(SOURCE_GRIST)!core!addons!fs!zfs>zfs.o
	kernel.so
	:
	$(SUBDIR)/core/addons/ldscripts/$(OBOS_ARCH)/addon.ld
	:
	-Bdynamic -shared
	;

KernelConfigSection config.$(OBOS_ARCH).ini : addons/fs/zfs : zfs ;

KernelLd isa
	:
	<$(SOURCE_GRIST)!core!addons!bus_managers!isa>isa.o
	kernel.so
	:
	$(SUBDIR)/core/addons/ldscripts/$(OBOS_ARCH)/addon.ld
	:
	-Bdynamic -shared
	;

KernelConfigSection config.$(OBOS_ARCH).ini : addons/bus_managers/isa : isa ;
KernelConfigSection config.$(OBOS_ARCH).ini : user-addons/bus_managers/isa : isa ;

KernelLd libglue.o :
	<$(SOURCE_GRIST)!glue>lib0.o
	:
	:
	-r
	:
	no_gcc
	;

KernelLd libm.so
	:
	libglue.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>fabs.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>frexp.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>isinf.o
	<$(SOURCE_GRIST)!libm!arch!$(OBOS_ARCH)>ldexp.o

	<$(SOURCE_GRIST)!libm!common>atan2.o 
	<$(SOURCE_GRIST)!libm!common>sincos.o
	<$(SOURCE_GRIST)!libm!common>tan.o

	<$(SOURCE_GRIST)!libm!common_source>acosh.o
	<$(SOURCE_GRIST)!libm!common_source>asincos.o 
	<$(SOURCE_GRIST)!libm!common_source>asinh.o 
	<$(SOURCE_GRIST)!libm!common_source>atan.o
	<$(SOURCE_GRIST)!libm!common_source>atanh.o 
	<$(SOURCE_GRIST)!libm!common_source>cosh.o 
	<$(SOURCE_GRIST)!libm!common_source>erf.o
	<$(SOURCE_GRIST)!libm!common_source>exp.o 
	<$(SOURCE_GRIST)!libm!common_source>exp__E.o 
	<$(SOURCE_GRIST)!libm!common_source>expm1.o 
	<$(SOURCE_GRIST)!libm!common_source>floor.o 
	<$(SOURCE_GRIST)!libm!common_source>fmod.o
	<$(SOURCE_GRIST)!libm!common_source>gamma.o 
	<$(SOURCE_GRIST)!libm!common_source>j0.o 
	<$(SOURCE_GRIST)!libm!common_source>j1.o 
	<$(SOURCE_GRIST)!libm!common_source>jn.o
	<$(SOURCE_GRIST)!libm!common_source>lgamma.o 
	<$(SOURCE_GRIST)!libm!common_source>log.o
	<$(SOURCE_GRIST)!libm!common_source>log10.o 
	<$(SOURCE_GRIST)!libm!common_source>log1p.o
	<$(SOURCE_GRIST)!libm!common_source>log__L.o 
	<$(SOURCE_GRIST)!libm!common_source>pow.o 
	<$(SOURCE_GRIST)!libm!common_source>sinh.o 
	<$(SOURCE_GRIST)!libm!common_source>tanh.o

	<$(SOURCE_GRIST)!libm!ieee>cabs.o
	<$(SOURCE_GRIST)!libm!ieee>cbrt.o
	<$(SOURCE_GRIST)!libm!ieee>support.o
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/library.ld
	:
	-shared -soname libm.so 
	:
	no_gcc
	;

KernelConfigSection config.$(OBOS_ARCH).ini : lib/libm.so : libm.so ;

KernelLd libc.so :
	libglue.o

	<$(SOURCE_GRIST)!libc>nulibc_init.o

	<$(SOURCE_GRIST)!libc!hoard>arch-specific.o
	<$(SOURCE_GRIST)!libc!hoard>heap.o
	<$(SOURCE_GRIST)!libc!hoard>processheap.o
	<$(SOURCE_GRIST)!libc!hoard>superblock.o
	<$(SOURCE_GRIST)!libc!hoard>threadheap.o
	<$(SOURCE_GRIST)!libc!hoard>wrapper.o
	
	<$(SOURCE_GRIST)!libc!locale>ctype.o

	<$(SOURCE_GRIST)!libc!stdio>stdio.o
	<$(SOURCE_GRIST)!libc!stdio>vsprintf.o

	<$(SOURCE_GRIST)!libc!stdlib>assert.o
	<$(SOURCE_GRIST)!libc!stdlib>atoi.o
	<$(SOURCE_GRIST)!libc!stdlib>bsearch.o
	<$(SOURCE_GRIST)!libc!stdlib>heapsort.o
	<$(SOURCE_GRIST)!libc!stdlib>merge.o
	<$(SOURCE_GRIST)!libc!stdlib>qsort.o
	<$(SOURCE_GRIST)!libc!stdlib>radixsort.o
	<$(SOURCE_GRIST)!libc!stdlib>rand.o
	<$(SOURCE_GRIST)!libc!stdlib>random.o

	<$(SOURCE_GRIST)!libc!string>bcopy.o
	<$(SOURCE_GRIST)!libc!string>bzero.o
	<$(SOURCE_GRIST)!libc!string>memchr.o
	<$(SOURCE_GRIST)!libc!string>memcmp.o
	<$(SOURCE_GRIST)!libc!string>memcpy.o
	<$(SOURCE_GRIST)!libc!string>memmove.o
	<$(SOURCE_GRIST)!libc!string>memset.o
	<$(SOURCE_GRIST)!libc!string>strcat.o
	<$(SOURCE_GRIST)!libc!string>strchr.o
	<$(SOURCE_GRIST)!libc!string>strcmp.o
	<$(SOURCE_GRIST)!libc!string>strcpy.o
	<$(SOURCE_GRIST)!libc!string>strerror.o
	<$(SOURCE_GRIST)!libc!string>strlcat.o
	<$(SOURCE_GRIST)!libc!string>strlcpy.o
	<$(SOURCE_GRIST)!libc!string>strlen.o
	<$(SOURCE_GRIST)!libc!string>strncat.o
	<$(SOURCE_GRIST)!libc!string>strncmp.o
	<$(SOURCE_GRIST)!libc!string>strncpy.o
	<$(SOURCE_GRIST)!libc!string>strnicmp.o
	<$(SOURCE_GRIST)!libc!string>strnlen.o
	<$(SOURCE_GRIST)!libc!string>strpbrk.o
	<$(SOURCE_GRIST)!libc!string>strrchr.o
	<$(SOURCE_GRIST)!libc!string>strspn.o
	<$(SOURCE_GRIST)!libc!string>strstr.o
	<$(SOURCE_GRIST)!libc!string>strtok.o

	<$(SOURCE_GRIST)!libc!system>dlfcn.o
	<$(SOURCE_GRIST)!libc!system>rlimit.o
	<$(SOURCE_GRIST)!libc!system>syscalls.o
	<$(SOURCE_GRIST)!libc!system!arch!$(OBOS_ARCH)>atomic.o

	<$(SOURCE_GRIST)!libc!unistd>close.o
	<$(SOURCE_GRIST)!libc!unistd>dup.o
	<$(SOURCE_GRIST)!libc!unistd>dup2.o
	<$(SOURCE_GRIST)!libc!unistd>lseek.o
	<$(SOURCE_GRIST)!libc!unistd>open.o
	<$(SOURCE_GRIST)!libc!unistd>pread.o
	<$(SOURCE_GRIST)!libc!unistd>pwrite.o
	<$(SOURCE_GRIST)!libc!unistd>read.o
	<$(SOURCE_GRIST)!libc!unistd>sleep.o
	<$(SOURCE_GRIST)!libc!unistd>usleep.o
	<$(SOURCE_GRIST)!libc!unistd>write.o
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/library.ld
	:
	-shared -soname libc.so
	:
	no_gcc
	;

KernelConfigSection config.$(OBOS_ARCH).ini : lib/libc.so : libc.so ;

KernelLd libglue2.o :
	<$(SOURCE_GRIST)!glue>crt0.o
	:
	:
	-r
	:
	no_gcc
	;
	
KernelLd init :
	libglue2.o
	<$(SOURCE_GRIST)!apps>init.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/init : init ;

KernelLd false :
	libglue2.o
	<$(SOURCE_GRIST)!apps>false_main.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/false : false ;

KernelLd fibo :
	libglue2.o
	<$(SOURCE_GRIST)!apps>fibo_main.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/fibo : fibo ;

KernelLd fortune :
	libglue2.o
	<$(SOURCE_GRIST)!apps!fortune>main.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/fortune : fortune ;

KernelLd ls :
	libglue2.o
	<$(SOURCE_GRIST)!apps!ls>main.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/ls : ls ;

KernelLd shell :
	libglue2.o
	<$(SOURCE_GRIST)!apps!shell>main.o
	<$(SOURCE_GRIST)!apps!shell>args.o
	<$(SOURCE_GRIST)!apps!shell>commands.o
	<$(SOURCE_GRIST)!apps!shell>file_utils.o
	<$(SOURCE_GRIST)!apps!shell>parse.o
	<$(SOURCE_GRIST)!apps!shell>script.o
	<$(SOURCE_GRIST)!apps!shell>shell_vars.o
	<$(SOURCE_GRIST)!apps!shell>statements.o
	libc.so
	libm.so
	:
	$(SUBDIR)/ldscripts/$(OBOS_ARCH)/app.ld
	:
	;

KernelConfigSection config.$(OBOS_ARCH).ini : bin/shell : shell ;

WriteKernelConfig config.$(OBOS_ARCH).ini : stage2 ;


SubInclude OBOS_TOP sources os kits kernel boot ;
SubInclude OBOS_TOP sources os kits kernel core ;
SubInclude OBOS_TOP sources os kits kernel drivers ;
SubInclude OBOS_TOP sources os kits kernel global ;
SubInclude OBOS_TOP sources os kits kernel glue ;
SubInclude OBOS_TOP sources os kits kernel libc ;
SubInclude OBOS_TOP sources os kits kernel libm ;
SubInclude OBOS_TOP sources os kits kernel apps ;
